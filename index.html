<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squad Tug: Official Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0b0e14; --card: #1c212b; --primary: #3b82f6; --accent: #fbbf24; --success: #10b981; --purple: #a855f7; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; height: 100vh; touch-action: none; user-select: none; }
        
        /* Layout Components */
        .header { padding: 15px 20px; background: #1e293b; display: flex; justify-content: space-between; border-bottom: 1px solid #334155; }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--accent); }

        .click-area { height: 38vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        #main-target { 
            width: 160px; height: 160px; border-radius: 50%; 
            background: radial-gradient(circle, #3b82f6, #1e3a8a); 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); 
            cursor: pointer; transition: transform 0.05s; z-index: 10;
        }
        #main-target:active { transform: scale(0.92); }
        #main-target img { width: 90px; height: 90px; object-fit: contain; pointer-events: none; }

        .tab-bar { display: flex; background: #2d3748; margin: 5px 15px; border-radius: 12px; border: 1px solid #3e4b5e; z-index: 50; position: relative; }
        .tab { flex: 1; padding: 12px 5px; border: none; background: none; color: #94a3b8; font-weight: bold; font-size: 10px; cursor: pointer; text-transform: uppercase; }
        .tab.active { background: var(--primary); color: white; border-radius: 10px; }

        /* Draggable Sheet */
        .market-sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--card); border-radius: 30px 30px 0 0; 
            height: 85vh; transform: translateY(75%);
            z-index: 100; box-shadow: 0 -10px 40px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column;
            will-change: transform; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .handle { height: 45px; width: 100%; display: flex; justify-content: center; align-items: center; cursor: ns-resize; touch-action: none; }
        .bar { width: 50px; height: 5px; background: #475569; border-radius: 10px; }
        .content { padding: 0 20px 60px; overflow-y: auto; flex: 1; }

        /* UI Elements */
        .item { background: #2d3748; padding: 12px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #3e4b5e; }
        .item-icon { width: 45px; height: 45px; background: #1e293b; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .buy-btn { border: none; padding: 10px 15px; border-radius: 10px; font-weight: bold; min-width: 90px; color: white; cursor: pointer; font-size: 12px; }
        .btn-available { background: var(--primary); box-shadow: 0 4px 0 #1d4ed8; }
        .btn-locked { background: #475569; opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }
        .btn-claim { background: var(--success); box-shadow: 0 4px 0 #059669; }

        .pop { position: absolute; color: var(--accent); font-weight: bold; animation: popUp 0.6s forwards; pointer-events: none; z-index: 200; font-size: 20px; }
        @keyframes popUp { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div class="header">
        <div><div style="font-size: 10px; color: #94a3b8;">SQUAD TUG BALANCE</div><div class="stat-val">$<span id="bal">0</span></div></div>
        <div style="text-align: right;"><div style="font-size: 10px; color: #94a3b8;">PASSIVE</div><div style="color: #10b981; font-weight: bold;">+$<span id="psv">0</span>/s</div></div>
    </div>

    <div class="click-area">
        <div id="main-target" onmousedown="doClick(event)" ontouchstart="doClick(event)">
            <img id="target-img" src="https://img.icons8.com/fluency/240/rocket.png">
        </div>
        <div style="margin-top:20px; width:80%;">
            <div id="nrg-t" style="font-size:11px; margin-bottom:4px;">Energy: 1000/1000</div>
            <div style="background:#334155; height:6px; border-radius:3px; overflow:hidden;"><div id="nrg-f" style="background:var(--success); width:100%; height:100%;"></div></div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab active" onclick="setTab('market')">Upgrades</button>
        <button class="tab" onclick="setTab('tasks')">Tasks</button>
        <button class="tab" onclick="setTab('skins')">Skins</button>
        <button class="tab" onclick="setTab('gamble')">Gamble</button>
    </div>

    <div class="market-sheet" id="sheet">
        <div class="handle" id="drag-handle"><div class="bar"></div></div>
        <div class="content" id="main-content"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        let currentTab = 'market';
        let isExpanded = false;

        // --- GAME STATE ---
        let game = JSON.parse(localStorage.getItem('squad_tug_v1')) || {
            bal: 10000, 
            psv: 0, nrg: 1000, mult: 1, clickPower: 1, 
            skin: 'https://img.icons8.com/fluency/240/rocket.png',
            up: { intern: 0, office: 0, manager: 0, factory: 0, clicker: 0 },
            tasks: { follow: false, join: false, invite: false },
            lastDaily: 0,
            hasReferralSkin: false,
            isNewPlayer: true
        };

        const config = {
            market: { 
                clicker:  { n: "Double Tap",  b: 100,    i: 0,   icon: "üëÜ", isClick: true },
                intern:   { n: "Intern",      b: 50,     i: 1,   icon: "üë∂" }, 
                office:   { n: "Small Office",b: 600,    i: 12,  icon: "üè¢" }, 
                manager:  { n: "Reg. Manager",b: 3500,   i: 75,  icon: "üëî" },
                factory:  { n: "Megafactory", b: 25000,  i: 500, icon: "üè≠" }
            },
            skins: { 
                car:   { n: "Supercar",  c: 10000,  img: "https://img.icons8.com/fluency/240/sport-car.png", icon: "üèéÔ∏è" }, 
                coin:  { n: "Gold Coin", c: 50000,  img: "https://img.icons8.com/fluency/240/gold-bars.png", icon: "ü™ô" }
            }
        };

        // --- UNIVERSAL DRAG LOGIC (Fixed) ---
        const sheet = document.getElementById('sheet');
        const handle = document.getElementById('drag-handle');
        let startY = 0, isDragging = false, currentTranslate = 75;
        const getY = (e) => e.touches ? e.touches[0].clientY : e.clientY;

        const startDrag = (e) => { startY = getY(e); isDragging = true; sheet.style.transition = 'none'; };
        const onDrag = (e) => {
            if (!isDragging) return;
            let next = (isExpanded ? 10 : 75) + ((getY(e) - startY) / window.innerHeight) * 100;
            if (next < 5) next = 5; if (next > 85) next = 85;
            sheet.style.transform = `translateY(${next}%)`;
            currentTranslate = next;
        };
        const endDrag = () => {
            if (!isDragging) return; isDragging = false;
            sheet.style.transition = 'transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)';
            isExpanded = currentTranslate < 45;
            sheet.style.transform = isExpanded ? 'translateY(10%)' : 'translateY(75%)';
        };

        handle.addEventListener('touchstart', startDrag, {passive: true});
        window.addEventListener('touchmove', onDrag, {passive: false});
        window.addEventListener('touchend', endDrag);
        handle.addEventListener('mousedown', startDrag);
        window.addEventListener('mousemove', onDrag);
        window.addEventListener('mouseup', endDrag);

        // --- ACTIONS ---
        function checkDaily() {
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000;
            if (now - game.lastDaily > oneDay) {
                game.bal += 5000;
                game.lastDaily = now;
                tg.showPopup({ title: 'Daily Bonus!', message: 'You claimed your $5,000 daily reward!' });
                render();
            }
        }

        function doTask(type) {
            if (game.tasks[type]) return;
            if (type === 'invite') {
                const inviteLink = `https://t.me/SquadTugBot?start=ref`;
                const text = encodeURIComponent(`üöÄ Build your empire with me in Squad Tug! Get $10k bonus!`);
                tg.openTelegramLink(`https://t.me/share/url?url=${inviteLink}&text=${text}`);
                game.tasks.invite = true; game.hasReferralSkin = true;
                game.skin = 'https://img.icons8.com/fluency/240/dragon.png';
            } else {
                tg.openLink(type === 'follow' ? 'https://twitter.com' : 'https://t.me/SquadTugBot');
                game.bal += 5000; game.tasks[type] = true;
            }
            render();
        }

        function setTab(t) { currentTab = t; render(); }

        function render() {
            document.getElementById('bal').innerText = Math.floor(game.bal).toLocaleString();
            document.getElementById('psv').innerText = (game.psv).toLocaleString();
            document.getElementById('target-img').src = game.skin;
            const container = document.getElementById('main-content');
            container.innerHTML = `<h3 style="text-transform:uppercase;">${currentTab}</h3>`;

            if(currentTab === 'market') {
                Object.keys(config.market).forEach(k => {
                    let item = config.market[k], cost = Math.floor(item.b * Math.pow(1.5, game.up[k])), locked = game.bal < cost;
                    container.innerHTML += `<div class="item"><div class="item-left"><div class="item-icon">${item.icon}</div><div><b>${item.n}</b><br><small>${item.isClick?'+1 tap':'+'+item.i+'/s'}</small></div></div><button class="buy-btn ${locked?'btn-locked':'btn-available'}" onclick="${locked?'':`buy('${k}',${cost},${item.isClick})`}">$${cost.toLocaleString()}</button></div>`;
                });
            } else if(currentTab === 'tasks') {
                container.innerHTML += `
                    <div class="item"><div class="item-left"><div class="item-icon">üì¢</div><div><b>Daily Bonus</b><br><small>+$5,000</small></div></div><button class="buy-btn btn-claim" onclick="checkDaily()">CLAIM</button></div>
                    <div class="item" style="border:1px solid var(--purple)"><div class="item-left"><div class="item-icon">üê≤</div><div><b>Invite Friend</b><br><small>DRAGON SKIN</small></div></div><button class="buy-btn ${game.tasks.invite?'btn-locked':'btn-claim'}" onclick="doTask('invite')">INVITE</button></div>
                `;
            } else if(currentTab === 'skins') {
                if(game.hasReferralSkin) container.innerHTML += `<div class="item" style="border:1px solid var(--purple)"><div class="item-left"><div class="item-icon">üê≤</div><div><b>Dragon</b></div></div><button class="buy-btn btn-available" onclick="game.skin='https://img.icons8.com/fluency/240/dragon.png';render()">EQUIP</button></div>`;
                Object.keys(config.skins).forEach(k => {
                    let s = config.skins[k], locked = game.bal < s.c;
                    container.innerHTML += `<div class="item"><div class="item-left"><div class="item-icon">${s.icon}</div><div><b>${s.n}</b></div></div><button class="buy-btn ${locked?'btn-locked':'btn-available'}" onclick="${locked?'':`buySkin('${s.img}',${s.c})`}">$${s.c.toLocaleString()}</button></div>`;
                });
            } else {
                container.innerHTML += `<div style="text-align:center; padding:20px; background:#1e293b; border-radius:20px;"><h1>üé≤</h1><button class="buy-btn btn-available" style="width:100%;" onclick="gamble()">BET 50%</button></div>`;
            }
            localStorage.setItem('squad_tug_v1', JSON.stringify(game));
        }

        function doClick(e) {
            if(e) e.preventDefault();
            if(game.nrg >= 1) { game.bal += game.clickPower; game.nrg--; showPop(e); tg.HapticFeedback.impactOccurred('light'); }
            render();
        }

        function buy(k, cost, isClick) {
            if(game.bal >= cost) { game.bal -= cost; game.up[k]++; if(isClick) game.clickPower++; else game.psv += config.market[k].i; render(); }
        }

        function buySkin(img, cost) { if(game.bal >= cost) { game.bal -= cost; game.skin = img; render(); } }

        function gamble() {
            let bet = game.bal * 0.5; if(bet < 1) return;
            if(Math.random() > 0.5) { game.bal += bet; tg.HapticFeedback.notificationOccurred('success'); }
            else { game.bal -= bet; tg.HapticFeedback.notificationOccurred('error'); }
            render();
        }

        function showPop(e) {
            const p = document.createElement('div'); p.className='pop'; p.innerText=`+$${game.clickPower}`;
            const x = (e && e.touches) ? e.touches[0].pageX : (e ? e.pageX : 150);
            const y = (e && e.touches) ? e.touches[0].pageY : (e ? e.pageY : 300);
            p.style.left = x + 'px'; p.style.top = y + 'px';
            document.body.appendChild(p); setTimeout(()=>p.remove(),600);
        }

        setInterval(() => { 
            game.bal += (game.psv / 10); if(game.nrg < 1000) game.nrg += 1; 
            document.getElementById('bal').innerText = Math.floor(game.bal).toLocaleString();
            document.getElementById('nrg-f').style.width = (game.nrg / 10) + "%";
        }, 100);

        if(game.isNewPlayer) {
            tg.showPopup({ title: 'Welcome to Squad Tug!', message: 'You received a $10,000 Starting Bonus!' });
            game.isNewPlayer = false;
        }

        render();
    </script>
</body>
</html>
