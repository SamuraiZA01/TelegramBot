<!DOCTYPE html>
<html>
<head>
    <title>DB TEST</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; line-height: 1.5; }
        .success { color: #0f0; font-weight: bold; }
        .fail { color: #f00; font-weight: bold; }
        .step { margin-bottom: 10px; border-left: 2px solid #333; padding-left: 10px; }
    </style>
</head>
<body>
    <h2>SUPABASE CONNECTIVITY DIAGNOSTIC</h2>
    <div id="terminal"></div>

    <script type="module">
        // Using a Module script to prevent "Supabase is not defined" errors
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

        const log = (msg, status = '') => {
            const div = document.createElement('div');
            div.className = 'step';
            div.innerHTML = `> ${msg} ... <span class="${status}">${status.toUpperCase()}</span>`;
            document.getElementById('terminal').appendChild(div);
        };

        async function runDiagnostic() {
            const SB_URL = "https://qkxbwxhvlcztjtnonjm.supabase.co"; 
            const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFreGJ3eGh2bGN6dGx6anRub2ptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MTA1NTYsImV4cCI6MjA4NDQ4NjU1Nn0.aoh-EdwTv42XhtIOHKveWtBMRHe25rYTk3UYguCOjh4";

            log("Testing Script Loading", "success");

            try {
                // 1. Initialize
                const supabase = createClient(SB_URL, SB_KEY);
                log("Supabase Client Initialization", "success");

                // 2. Network Ping
                log("Pinging Supabase Server");
                const { data, error } = await supabase.from('leaderboard').select('*').limit(1);

                if (error) {
                    if (error.message.includes("Failed to fetch")) {
                        log("Network Error: Check if RLS is on or URL is blocked", "fail");
                    } else {
                        log("Table Error: " + error.message, "fail");
                    }
                    console.error(error);
                } else {
                    log("Connection Verified", "success");
                    log("Data Received: " + JSON.stringify(data), "success");
                }

                // 3. Permission Check
                log("Testing Write Permission");
                const { error: writeErr } = await supabase.from('leaderboard').upsert({
                    user_id: "diagnostic_test",
                    username: "Tester",
                    balance: 1
                });

                if (writeErr) {
                    log("Write Failed: " + writeErr.message, "fail");
                } else {
                    log("Write Permission Verified", "success");
                }

            } catch (err) {
                log("CRITICAL SCRIPT CRASH: " + err.message, "fail");
            }
        }

        runDiagnostic();
    </script>
</body>
</html>
