<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Empire Master</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #0b0e14; --card: #1c212b; --primary: #3b82f6; --accent: #fbbf24; --success: #10b981; --locked: #475569; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow: hidden; height: 100vh; touch-action: none; }
        
        /* Stats Display */
        .header { padding: 15px 20px; background: #1e293b; display: flex; justify-content: space-between; border-bottom: 1px solid #334155; }
        .stat-val { font-size: 24px; font-weight: 800; color: var(--accent); }

        /* Game Area */
        .click-area { height: 40vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #main-target { width: 160px; height: 160px; border-radius: 50%; background: radial-gradient(circle, #3b82f6, #1e3a8a); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(59, 130, 246, 0.4); cursor: pointer; transition: transform 0.05s; }
        #main-target img { width: 90px; height: 90px; object-fit: contain; }

        /* Navigation Tabs */
        .tab-bar { display: flex; background: #2d3748; margin: 5px 20px; border-radius: 12px; border: 1px solid #3e4b5e; position: relative; z-index: 50; }
        .tab { flex: 1; padding: 10px; border: none; background: none; color: #94a3b8; font-weight: bold; font-size: 11px; }
        .tab.active { background: var(--primary); color: white; border-radius: 10px; }

        /* DRAGGABLE MARKET SHEET */
        .market-sheet { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--card); border-radius: 30px 30px 0 0; 
            height: 85vh; transform: translateY(75%); /* Default peek position */
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.1);
            z-index: 100; box-shadow: 0 -10px 40px rgba(0,0,0,0.6); 
            display: flex; flex-direction: column;
        }
        .market-sheet.full { transform: translateY(10%); }
        .market-sheet.peek { transform: translateY(75%); }

        .handle { height: 45px; width: 100%; display: flex; justify-content: center; align-items: center; cursor: grab; }
        .bar { width: 50px; height: 5px; background: #475569; border-radius: 10px; }
        
        .content { padding: 0 20px 20px; overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }

        /* Upgrades List */
        .item { background: #2d3748; padding: 12px; border-radius: 16px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #3e4b5e; }
        .item-left { display: flex; align-items: center; gap: 12px; }
        .item-icon { width: 45px; height: 45px; background: #1e293b; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        
        .buy-btn { border: none; padding: 12px; border-radius: 12px; font-weight: bold; min-width: 110px; color: white; }
        .btn-available { background: var(--primary); box-shadow: 0 4px 0 #1d4ed8; }
        .btn-locked { background: var(--locked); opacity: 0.5; filter: grayscale(1); }

        .pop { position: absolute; color: var(--accent); font-weight: bold; animation: popUp 0.6s forwards; pointer-events: none; z-index: 200; }
        @keyframes popUp { to { transform: translateY(-100px); opacity: 0; } }
    </style>
</head>
<body>

    <div class="header">
        <div><div style="font-size: 10px; color: #94a3b8;">BALANCE</div><div class="stat-val">$<span id="bal">0</span></div></div>
        <div style="text-align: right;"><div style="font-size: 10px; color: #94a3b8;">EARNINGS</div><div style="color: #10b981; font-weight: bold;">+$<span id="psv">0</span>/s</div></div>
    </div>

    <div class="click-area">
        <div id="main-target" onclick="doClick(event)"><img id="target-img" src="https://img.icons8.com/fluency/240/rocket.png"></div>
        <div style="margin-top:20px; width:80%;">
            <div id="nrg-t" style="font-size:11px; margin-bottom:4px;">Energy: 1000/1000</div>
            <div style="background:#334155; height:6px; border-radius:3px; overflow:hidden;"><div id="nrg-f" style="background:var(--success); width:100%; height:100%;"></div></div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab active" onclick="setTab('market')">üè¢ ITEMS</button>
        <button class="tab" onclick="setTab('skins')">üëï SKINS</button>
        <button class="tab" onclick="setTab('gamble')">üé∞ RISK</button>
    </div>

    <div class="market-sheet" id="sheet">
        <div class="handle" id="drag-handle">
            <div class="bar"></div>
        </div>
        <div class="content" id="main-content"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        let currentTab = 'market';
        let isExpanded = false;

        let game = JSON.parse(localStorage.getItem('pixel_v5')) || {
            bal: 0, psv: 0, nrg: 1000, mult: 1, skin: 'https://img.icons8.com/fluency/240/rocket.png',
            up: { intern: 0, office: 0, manager: 0, factory: 0, city: 0, colony: 0 }
        };

        const config = {
            market: { 
                intern:  { n: "Intern",   b: 50,     i: 1,    icon: "üë∂" }, 
                office:  { n: "Office",   b: 600,    i: 12,   icon: "üè¢" }, 
                manager: { n: "Manager",  b: 3500,   i: 75,   icon: "üëî" },
                factory: { n: "Factory",  b: 20000,  i: 450,  icon: "üè≠" },
                city:    { n: "Tech Hub", b: 120000, i: 2800, icon: "üåÜ" },
                colony:  { n: "Mars Base",b: 1000000,i: 25000,icon: "üöÄ" }
            },
            skins: { 
                car: { n: "Supercar", c: 10000, img: "https://img.icons8.com/fluency/240/sport-car.png", icon: "üèéÔ∏è" }, 
                coin: { n: "Gold Coin", c: 50000, img: "https://img.icons8.com/fluency/240/gold-bars.png", icon: "ü™ô" },
                crown: { n: "Crown", c: 250000, img: "https://img.icons8.com/fluency/240/crown.png", icon: "üëë" }
            }
        };

        // DRAG LOGIC
        const sheet = document.getElementById('sheet');
        const handle = document.getElementById('drag-handle');
        
        handle.addEventListener('click', () => {
            isExpanded = !isExpanded;
            sheet.className = isExpanded ? 'market-sheet full' : 'market-sheet peek';
        });

        function setTab(t) {
            currentTab = t;
            document.querySelectorAll('.tab').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(t)));
            render();
        }

        function render() {
            document.getElementById('bal').innerText = Math.floor(game.bal).toLocaleString();
            document.getElementById('psv').innerText = (game.psv * game.mult).toLocaleString();
            document.getElementById('target-img').src = game.skin;
            
            const container = document.getElementById('main-content');
            container.innerHTML = `<h3 style="margin-bottom:15px; text-transform:uppercase;">${currentTab}</h3>`;

            if(currentTab === 'market') {
                Object.keys(config.market).forEach(k => {
                    let item = config.market[k]; 
                    let cost = Math.floor(item.b * Math.pow(1.4, game.up[k]));
                    let locked = game.bal < cost;
                    container.innerHTML += `
                        <div class="item">
                            <div class="item-left">
                                <div class="item-icon">${item.icon}</div>
                                <div><b>${item.n}</b><br><small style="color:#94a3b8">+${item.i}/s (Lv ${game.up[k]})</small></div>
                            </div>
                            <button class="buy-btn ${locked ? 'btn-locked' : 'btn-available'}" 
                                    onclick="${locked ? '' : `buy('${k}',${cost})`}">
                                ${locked ? 'üîí ' : ''}$${cost.toLocaleString()}
                            </button>
                        </div>`;
                });
            } else if(currentTab === 'skins') {
                Object.keys(config.skins).forEach(k => {
                    let s = config.skins[k]; let locked = game.bal < s.c;
                    container.innerHTML += `
                        <div class="item">
                            <div class="item-left"><div class="item-icon">${s.icon}</div><div><b>${s.n}</b></div></div>
                            <button class="buy-btn ${locked ? 'btn-locked' : 'btn-available'}" 
                                    onclick="${locked ? '' : `buySkin('${s.img}',${s.c})`}">$${s.c.toLocaleString()}</button>
                        </div>`;
                });
            } else {
                container.innerHTML += `<div style="text-align:center; padding:30px; background:#1e293b; border-radius:20px;">
                    <h1 style="font-size:50px; margin:0;">üé∞</h1>
                    <p>Wager 50% of your current balance.</p>
                    <button class="buy-btn btn-available" style="width:100%; height:60px;" onclick="gamble()">BET $${Math.floor(game.bal * 0.5).toLocaleString()}</button>
                </div>`;
            }
            localStorage.setItem('pixel_v5', JSON.stringify(game));
        }

        function doClick(e) {
            if(game.nrg >= 1) { 
                game.bal += (1 * game.mult); game.nrg--; 
                showPop(e, (1 * game.mult)); 
                tg.HapticFeedback.impactOccurred('light'); render(); 
            } else { tg.HapticFeedback.notificationOccurred('warning'); }
        }

        function buy(k, cost) {
            if(game.bal >= cost) { 
                game.bal -= cost; game.up[k]++; game.psv += config.market[k].i; 
                tg.HapticFeedback.notificationOccurred('success'); render(); 
            }
        }

        function buySkin(img, cost) { if(game.bal >= cost) { game.bal -= cost; game.skin = img; render(); } }

        function gamble() {
            let bet = game.bal * 0.5; if(bet < 1) return;
            if(Math.random() > 0.5) { game.bal += bet; tg.HapticFeedback.notificationOccurred('success'); alert("JACKPOT! You won."); }
            else { game.bal -= bet; tg.HapticFeedback.notificationOccurred('error'); alert("BUST! Better luck next time."); }
            render();
        }

        function showPop(e, g) {
            const p = document.createElement('div'); p.className='pop'; p.innerText=`+$${g}`; p.style.left=e.pageX+'px'; p.style.top=e.pageY+'px';
            document.body.appendChild(p); setTimeout(()=>p.remove(),600);
        }

        setInterval(() => { game.bal += (game.psv * game.mult / 10); if(game.nrg < 1000) game.nrg += 0.8; render(); }, 100);
        render();
    </script>
</body>
</html>
