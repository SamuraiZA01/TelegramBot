<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Clicker Game</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; user-select: none; }
        #balance { font-size: 48px; margin: 20px 0; color: #f1c40f; }
        #click-btn { 
            width: 200px; height: 200px; border-radius: 50%; border: none; 
            background: radial-gradient(circle, #f1c40f, #d35400);
            box-shadow: 0 10px 20px rgba(241, 196, 15, 0.4);
            cursor: pointer; font-size: 24px; font-weight: bold; color: white;
        }
        #click-btn:active { transform: scale(0.95); }
        #status { margin-top: 20px; font-size: 14px; color: #888; }
    </style>
</head>
<body>

    <h2 id="welcome">Welcome, Player</h2>
    <div id="balance">0</div>
    <button id="click-btn">CLICK!</button>
    <div id="status">Connecting to database...</div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://xoxcfctitnucpinlkqbk.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhveGNmY3RpdG51Y3BpbmxrcWJrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODkwODI5OSwiZXhwIjoyMDg0NDg0Mjk5fQ.7EJmB0mJqRacDAVR1oW2aE7NkwYLSClMfqLGYSpXtzk";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;
        
        // State
        let score = 0;
        let userId = "guest";
        let username = "Guest Player";

        // --- INITIALIZATION ---
        async function init() {
            tg.expand(); // Make the app full screen
            
            // Get user data from Telegram
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const user = tg.initDataUnsafe.user;
                userId = String(user.id);
                username = user.username || user.first_name || "Unknown";
                document.getElementById('welcome').innerText = `Welcome, ${username}`;
            }

            document.getElementById('status').innerText = "Fetching your data...";
            
            // Load user from Supabase or Create if new
            try {
                const { data, error } = await supabase
                    .from('leaderboard')
                    .select('balance')
                    .eq('user_id', userId)
                    .single();

                if (data) {
                    score = data.balance;
                    updateUI();
                    document.getElementById('status').innerText = "Data loaded.";
                } else {
                    // New user: Create them in DB
                    await supabase.from('leaderboard').insert([
                        { user_id: userId, username: username, balance: 0 }
                    ]);
                    document.getElementById('status').innerText = "New profile created!";
                }
            } catch (err) {
                document.getElementById('status').innerText = "Offline Mode (Dev)";
            }
        }

        // --- GAME LOGIC ---
        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(score).toLocaleString();
        }

        document.getElementById('click-btn').addEventListener('click', () => {
            score += 1;
            updateUI();
            saveToDatabase();
        });

        // Save to Supabase (debounced to avoid spamming the API)
        let saveTimeout;
        function saveToDatabase() {
            clearTimeout(saveTimeout);
            document.getElementById('status').innerText = "Saving...";
            
            saveTimeout = setTimeout(async () => {
                const { error } = await supabase
                    .from('leaderboard')
                    .upsert({ 
                        user_id: userId, 
                        username: username, 
                        balance: score 
                    }, { onConflict: 'user_id' });

                if (!error) {
                    document.getElementById('status').innerText = "Synced with Cloud";
                } else {
                    document.getElementById('status').innerText = "Sync Error: " + error.message;
                }
            }, 1000); // Wait 1 second after last click before saving
        }

        // Start the app
        init();
    </script>
</body>
</html>
